---
- name: Check if Mesa build dir exists
  stat:
    path: "{{ sources }}/mesa/{{ build_folder }}"
  register: mesa_build
- name: Mesa
  when: git_mesa.changed or "mesa" in rebuild or not mesa_build.stat.exists
  block:
    - name: Configure mesa
      args:
        chdir: "{{ sources }}/mesa"
      shell:
        "{{ playbook_dir }}/../conf_mesa.sh {{ arch_extra_arg }}"
    - name: Build+Install mesa
      args:
        chdir: "{{ sources }}/mesa"
      shell:
         "ninja -C {{ build_folder }} install -j {{ jobs }}"
  rescue:
    - name: Fail
      ansible.builtin.command: /bin/false
