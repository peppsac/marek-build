---
- name: Check if llvm build dir exists
  stat:
    path: "{{ sources }}/llvm-project/{{ build_folder }}"
  register: llvm_build
- name: llvm
  when: git_llvm.changed or "llvm" in rebuild or not llvm_build.stat.exists
  block:
    - name: "Configure llvm"
      args:
        chdir: "{{ sources }}/llvm-project"
      shell:
        "{{ playbook_dir }}/../conf_llvm.sh {{ arch_extra_arg }}"
    - name: Build+Install llvm
      args:
        chdir: "{{ sources }}/llvm-project"
      shell:
        ninja -C {{ build_folder }} install -j "{{ [ jobs | int, (ansible_facts['memtotal_mb'] / 1500) | round | int ] | min }}"
  rescue:
    - name: Cleanup on errors
      ansible.builtin.file:
        path: "{{ sources }}/llvm-project/{{ build_folder }}"
        state: absent
    - name: Fail
      ansible.builtin.command: /bin/false
- name: Create llvm config file
  shell: |
    sed -i "/llvm_config/d" "{{ playbook_dir }}/../{{ arch }}.ini"
    echo "\nllvm_config = '{{ prefix }}/llvm-{{ arch }}/bin/llvm-config'" >> "{{ playbook_dir }}/../{{ arch }}.ini"
